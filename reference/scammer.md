# 사기꾼 조회 페이지 제작

## 데이터 스키마
### 사기꾼
```postgresql
-- =========================================================
-- scammer : 블랙리스트 원장
-- =========================================================
create table public.scammer (
  id bigint generated by default as identity primary key,
  name text null,
  phone_number text,
  bank_account_number text,
    description text,
  created_at timestamptz not null default now(),
  created_by bigint
      references public.users(id)
                on delete set null
);

-- =========================================================
-- scammer_search : 일 단위 검색 건수 집계
-- =========================================================
create table public.scammer_search (
 stat_date date primary key,      -- KST 기준 날짜
 count bigint not null default 0  -- 해당 날짜의 검색 누적 건수
);
```
- 이미 supabase에 생성되어있음

## UI/UX 구현

### 사기꾼 검색 컴포넌트

- /reference/scammer-search-bar.png 를 참고하여 페이지 레이아웃 제작
- 다만 참고 페이지와는 다르게 무조건 이름, 전화번호, 계좌번호 단일로 검색
- 검색 창 맨 왼쪽에 이름, 전화번호, 계좌번호 선택할 수 있는 드롭리스트가 존재

### 페이지네이션 바 컴포넌트
- 이 프로젝트에서 공통으로 쓰일 수 있는 페이지네이션 바를 제작
- 번호형으로 제작. 페이지 번호로 표시함
- 페이지네이션 바를 위해서 total count도 각 api에서 가져옴

### 사기꾼 조회 페이지
- /scammer
- 사기꾼 검색 컴포넌트 활용 (위)
- /reference/scammer-page-bottom.png를 참고하여 레이아웃 구성 (아래)

### 사기꾼 검색 결과 페이지
- /scammer/result
- 사기꾼 검색 컴포넌트 활용 (위)
- 사기꾼 목록 (아래)
  - 좌측부터 이름, 전화번호, 계좌번호, 설명(description) 로 배치
  - 목록은 order by id desc로 아래로 쭉 내려짐
- 사기꾼 목록 아래에 페이지네이션 바 배치

### 사기꾼 관리 페이지
- /admin/scammer
- 사기꾼 목록들이 보임
- 각 목록 오른쪽에는 수정, 삭제 버튼이 존재
- 목록 우측 상단에는 추가 버튼이 존재
- 추가, 수정 버튼을 누르면 모달이 뜸

## 행동정의
### 사기꾼 검색
- 검색 실행은 로그인한 사용자만 가능. 
- 로그인하지 않은 사용자는 '로그인이 필요한 기능입니다.' alert이 뜨고 login 페이지로 리디렉션
- 로그인을 하고 나면 다시 돌아옴
- 사용자의 종류 선택 + 문자열에 따라 다음 쿼리 발생 

이름
```postgresql
-- total
select count(*)::bigint as total
from public.scammer
where name like '%' || :q || '%';

-- page items
select *
from public.scammer
where name like '%' || :q || '%'
order by id desc
limit :limit
    offset :offset;
```
전화번호 (하이픈 제거해서 저장한다는 전제)
```postgresql
select count(*)::bigint as total
from public.scammer
where phone_number like '%' || :q || '%';

select *
from public.scammer
where phone_number like '%' || :q || '%'
order by id desc
limit :limit
    offset :offset;
```
계좌번호
```postgresql
select count(*)::bigint as total
from public.scammer
where bank_account_number like '%' || :q || '%';

select *
from public.scammer
where bank_account_number like '%' || :q || '%'
order by id desc
limit :limit
    offset :offset;
```
- 검색 발동 최소 조건 문자열 길이
  - 전화/계좌: 4자리 이상부터 검색 허용
  - 이름: 2자리 이상부터 검색 허용

- 검색이 발동했을 때 scammer_search의 count를 1 증가 시킨다. (row가 없으면 create)
  - page=1일 때만 +1 (실제 “검색” 1회만 집계)

```postgresql
insert into public.scammer_search (stat_date, count)
values ((now() at time zone 'Asia/Seoul')::date, 1)
on conflict (stat_date)
do update set count = public.scammer_search.count + 1;
```

### 사기꾼 등록, 수정, 삭제
- 관리자 페이지에서 등록, 수정, 삭제 가능. users.role = 'admin' 만 가능.
- 삭제 누르면 곧바로 삭제
- 등록, 수정 시 아래 컬럼 중에 최소 하나의 컬럼은 채워져야함
  - 이름
  - 전화번호
  - 계좌번호
- 전화번호, 계좌번호는 하이픈 제거해서 저장
